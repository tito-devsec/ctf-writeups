# neboCTF — Web Exploitation Write-Up: Tech Shop (Client-Side Trust Vulnerability)

## Challenge Details

*   **CTF:** neboCTF
*   **Category:** Web Exploitation
*   **Challenge Name:** Tech Shop
*   **Difficulty:** Medium
*   **Author:** TitoDevsec (T1t0D3v$3c)

## 1. Introduction

This write-up documents the exploitation of a client-side trust vulnerability within the "Tech Shop" challenge from neboCTF. The challenge presented a simulated e-commerce platform where users could register, log in, view products, and attempt purchases. A critical observation was that despite displaying product prices and a user balance, all "Buy" buttons were initially disabled, and the user's balance was insufficient for any listed item. This scenario is indicative of a common security flaw where an application relies on client-side controls for critical business logic, rather than enforcing these rules server-side.

## 2. Initial Analysis and Vulnerability Hypothesis

Upon logging into the Tech Shop, the application displayed the logged-in username, a balance of $50.00, and a list of products with significantly higher prices (e.g., "Basic T-Shirt – $199.99", "Premium Flag – $999.00", "Secret Key – $500.00"). All purchase buttons were rendered as disabled. This setup immediately suggested a potential client-side trust issue, where the application might be delegating critical validation to the user's browser.

Interception of HTTP traffic using Burp Suite revealed that the backend server was running `Werkzeug/3.1.5 Python/3.11.14`, indicating a Flask application. The session cookie, named `session`, was identified as a Flask-signed session cookie. Decoding the Base64-encoded portion of the cookie revealed a JSON structure containing `user_id` and `username` (e.g., `{"user_id":6,"username":"admin"}`). This confirmed that the session data was signed but not encrypted, meaning its integrity was protected, but its contents were readable by the client.

Further examination of the product purchase forms in the HTML source code revealed a critical design flaw:

```html
<form method="POST" action="/buy">
    <input type="hidden" name="product_id" value="2">
    <input type="hidden" name="price" value="999.0">
    <button type="submit" disabled>Buy</button>
</form>
```

### Key Observations:

*   **Client-Side Price Transmission:** The `price` of the product was embedded as a hidden input field within the HTML form, implying that the client was responsible for sending the price to the server.
*   **UI-Based Disablement:** The "Buy" button was disabled purely on the client-side, offering no server-side enforcement against submission.
*   **Flask Backend:** The use of Flask and signed session cookies indicated a typical web application architecture.

These observations led to the hypothesis that the server might be trusting the `price` value submitted by the client, rather than retrieving the authoritative price from its own database. This is a classic example of a **Broken Business Logic** vulnerability, specifically a **Client-Side Trust** issue, where security decisions are made based on user-controlled input without proper server-side validation.

## 3. Exploitation: Bypassing Client-Side Controls

The objective of the exploitation phase was to manipulate the product price and successfully purchase an item despite the client-side restrictions. Given that the `price` was sent from the client and the button was merely disabled in the UI, a direct POST request could bypass these superficial controls.

Instead of interacting with the disabled button, a `curl` command was crafted to manually send a POST request to the `/buy` endpoint. The `product_id` for the "Premium Flag" (ID 2) was identified, and the `price` parameter was intentionally set to `0`.

### Exploitation Command:

```bash
curl -i -X POST http://136.115.44.64:5010/buy \
-H "Cookie: session=eyJ1c2VyX2lkIjo2LCJ1c2VybmFtZSI6ImFkbWluIn0.aZzXMg.TaDw3xkaL0ntaG9DIzuxgQJU6J8" \
-d "product_id=2&price=0"
```

### Server Response:

```
You bought Premium Flag for $0.00.
New balance: $50.00
FLAG{client_side_controls_are_not_security}
```

The server's response confirmed the successful purchase of the "Premium Flag" for $0.00, and the flag `FLAG{client_side_controls_are_not_security}` was revealed. This unequivocally demonstrated that the backend was trusting the client-supplied price, leading to a critical business logic bypass.

## 4. Root Cause and Vulnerability Classification

The core vulnerability lies in the application's failure to enforce business logic on the server-side. The backend implicitly trusted the `price` parameter submitted by the client, rather than performing an authoritative lookup of the product's price from its own database. A simplified representation of the vulnerable server-side logic would be:

```python
price = float(request.form['price']) # ❌ Trusting client-provided price
if balance >= price:
    balance -= price
```

Instead of the secure approach:

```python
product = get_product(product_id)
price = product.price # ✅ Price retrieved from database
if current_user.balance >= price:
    current_user.balance -= price
```

This vulnerability is classified as **Broken Business Logic** or **Client-Side Trust**. It highlights the fundamental security principle: **Never trust data originating from the client.** Client-side controls (like disabled buttons or hidden input fields) are easily bypassed and serve only for user experience, not security enforcement.

## 5. Real-World Impact

In a real-world e-commerce application, such a vulnerability could lead to severe financial and reputational damage, including:

*   **Free Purchases:** Customers could acquire expensive products for free or at significantly reduced prices.
*   **Negative Price Exploitation:** Attackers might submit negative prices to artificially inflate their account balance.
*   **Financial Loss:** Direct monetary losses for the business due as products are given away without payment.
*   **Business Logic Compromise:** The integrity of the entire purchasing system could be undermined, leading to widespread fraud.
*   **Reputational Damage:** Loss of customer trust and brand credibility due to security breaches.

## 6. Mitigation Strategies

To prevent client-side trust vulnerabilities and enforce robust business logic, developers must implement comprehensive server-side validation for all critical operations:

*   **Server-Side Price Validation:** Always retrieve the authoritative price of a product from the server's database. Never rely on price values submitted by the client.
*   **Remove Sensitive Data from Client:** Do not include critical business parameters like `price` in hidden input fields or other client-side accessible locations.
*   **Server-Side Balance Checks:** All balance deductions and purchase validations must occur exclusively on the server, after verifying the legitimate product price.
*   **Robust Input Validation:** Implement strict server-side validation for all user inputs, ensuring they conform to expected data types, formats, and business rules.
*   **Avoid Client-Side Security:** Understand that client-side controls (JavaScript validation, disabled buttons, hidden fields) are for usability only and offer no security guarantees.

### Secure Implementation Example:

```python
@app.route("/buy", methods=["POST"])
def buy():
    product_id = request.form["product_id"]
    
    product = Product.query.filter_by(id=product_id).first()
    
    if not product:
        return "Invalid product", 400
    
    price = product.price  # ✅ Price retrieved from database, not client
    
    if current_user.balance >= price:
        current_user.balance -= price
        db.session.commit()
        return "Purchase successful"
    else:
        return "Insufficient balance", 403
```

## 7. Conclusion

The "Tech Shop" challenge serves as an excellent illustration of the dangers associated with client-side trust vulnerabilities. It underscores the fundamental principle that all security-sensitive operations and business logic must be enforced on the server-side. Relying on client-side controls for security is a critical mistake that can lead to severe exploitation, allowing attackers to bypass intended functionality and cause significant harm. This exercise reinforces the importance of a defense-in-depth approach, where every layer of the application, especially the backend, rigorously validates and controls user interactions.

## References

[1] OWASP Foundation. (n.d.). *Business Logic Flaws*. Retrieved from [https://owasp.org/www-community/vulnerabilities/Business_logic_flaws](https://owasp.org/www-community/vulnerabilities/Business_logic_flaws)
[2] PortSwigger. (n.d.). *Client-side controls*. Retrieved from [https://portswigger.net/web-security/all-topics/client-side-controls](https://portswigger.net/web-security/all-topics/client-side-controls)
